<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Systan Typing</title>
<style>
body{
  font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Noto Sans JP";
  margin:0;
  background:#050816;
  color:#eef1ff;
}
main{max-width:900px;margin:0 auto;padding:20px;}
.panel{
  background:#14183a;
  border:1px solid rgba(255,255,255,.1);
  border-radius:18px;
  padding:18px 18px 22px;
  box-shadow:0 18px 40px rgba(0,0,0,.45);
}
h1{font-size:22px;margin:0 0 12px;}
h1 span{font-size:13px;font-weight:400;opacity:.7;margin-left:8px;}
.grid{
  display:grid;
  gap:10px;
  grid-template-columns:repeat(4,1fr);
}
label{font-size:12px;opacity:.9;display:block;margin-bottom:4px;}
select,input[type=number],button,input[type=text]{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.18);
  background:#0f1333;
  color:#eef1ff;
  box-sizing:border-box;
}
select:focus,input:focus,button:focus{
  outline:2px solid #6c8bff;
  outline-offset:1px;
}
button{
  cursor:pointer;
  transition:transform .1s,box-shadow .1s,background .15s;
}
button.primary{
  background:#3c5cff;
  border-color:#5f79ff;
  font-weight:700;
  box-shadow:0 6px 18px rgba(60,92,255,.45);
}
button.primary:active{transform:translateY(1px);box-shadow:0 3px 10px rgba(0,0,0,.4);}
button.sub{
  background:#20264a;
}
button.warn{
  background:#ff7b5c;
  border-color:#ffb29e;
}
.statbox{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  margin-top:10px;
}
.stat{
  background:#0f1435;
  border:1px dashed rgba(255,255,255,.15);
  padding:8px;
  border-radius:10px;
  font-size:12px;
}
.stat strong{display:block;font-size:11px;opacity:.7;margin-bottom:4px;}
.prompt{margin-top:16px;font-size:18px;min-height:32px;}
.hint{
  margin-top:10px;
  font-family:ui-monospace,Menlo,Consolas,monospace;
  background:#0b0f29;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.08);
  min-height:26px;
  font-size:15px;
}
.hint.flash-answer{
  color:#fffa9e;
  border-color:#ffe066;
  background:#3b2a00;
  animation:flash 0.8s ease-in-out 2;
}
@keyframes flash{
  0%{opacity:0;}
  40%{opacity:1;}
  80%{opacity:.1;}
  100%{opacity:1;}
}
#input{
  margin-top:12px;
  font-size:16px;
}
.controls-row{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.controls-row > *{flex:1 1 0;}
.controls-row .small{flex:0 0 auto;font-size:12px;white-space:nowrap;}
#feedback{margin-top:8px;font-size:12px;opacity:.9;min-height:16px;}
.log{
  margin-top:12px;
  background:#0f1435;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.1);
  padding:10px;
  font-size:12px;
  max-height:200px;
  overflow:auto;
  display:none;
}
.log-entry.ok{color:#7fffb0;}
.log-entry.ng{color:#ff9d8b;}

.overlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(circle at top,#202a5a90,#050816f0);
  backdrop-filter:blur(6px);
  z-index:999;
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease-out;
}
.overlay.visible{
  opacity:1;
  pointer-events:auto;
}
.result-card{
  background:#111633;
  border-radius:20px;
  padding:22px 24px 20px;
  text-align:center;
  border:1px solid rgba(255,255,255,.22);
  box-shadow:0 24px 60px rgba(0,0,0,.7);
  min-width:260px;
  max-width:320px;
  position:relative;
  overflow:hidden;
}
.result-title{
  font-size:26px;
  margin-bottom:4px;
}
.result-badge{
  display:inline-block;
  margin-bottom:8px;
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  background:linear-gradient(90deg,#ffcf71,#f76b1c);
  color:#222;
  font-weight:700;
}
.result-detail{
  font-size:13px;
  opacity:.9;
  margin-bottom:6px;
}
.result-small{
  font-size:11px;
  opacity:.7;
}
.result-close{
  margin-top:10px;
  padding:7px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.5);
  background:transparent;
  color:#fff;
  font-size:12px;
}
.confetti-piece{
  position:absolute;
  width:6px;
  height:12px;
  background:#ffeb3b;
  top:-20px;
  border-radius:2px;
  opacity:0;
  animation:confetti-fall 1.8s ease-out forwards;
}
@keyframes confetti-fall{
  0%{transform:translate3d(0,-40px,0) rotateZ(0deg);opacity:0;}
  10%{opacity:1;}
  100%{transform:translate3d(var(--dx,0),320px,0) rotateZ(360deg);opacity:0;}
}

@media (max-width:640px){
  .grid{grid-template-columns:repeat(2,1fr);}
  .statbox{grid-template-columns:repeat(3,1fr);}
  main{padding:14px;}
}
</style>
</head>
<body>
<main>
  <h1>Systan Typing <span>System英単語 No.1–100 タイピング練習</span></h1>
  <div class="panel">
    <div class="grid">
      <div>
        <label>範囲（開始No.）</label>
        <input id="startId" type="number" min="1" max="100" value="1"/>
      </div>
      <div>
        <label>範囲（終了No.）</label>
        <input id="endId" type="number" min="1" max="100" value="100"/>
      </div>
      <div>
        <label>並び順</label>
        <select id="order">
          <option value="shuffle" selected>ランダム</option>
          <option value="asc">番号順</option>
          <option value="desc">番号逆順</option>
        </select>
      </div>
      <div>
        <label>判定</label>
        <select id="judge">
          <option value="strict" selected>厳密（完全一致）</option>
          <option value="loose">ゆるめ（大文字小文字/空白無視）</option>
        </select>
      </div>
    </div>

    <div class="statbox">
      <div class="stat"><strong>進行</strong><span id="progress">0 / 0</span></div>
      <div class="stat"><strong>正答</strong><span id="correct">0</span></div>
      <div class="stat"><strong>ミス / スキップ</strong><span id="mist">0</span></div>
      <div class="stat"><strong>WPM</strong><span id="wpm">0</span></div>
      <div class="stat"><strong>残り時間</strong><span id="remain">--:--</span></div>
    </div>

    <div class="grid" style="margin-top:10px;">
      <div>
        <label>制限時間</label>
        <select id="limit">
          <option value="0" selected>なし</option>
          <option value="1">1分</option>
          <option value="2">2分</option>
          <option value="3">3分</option>
          <option value="4">4分</option>
          <option value="5">5分</option>
        </select>
      </div>
      <div>
        <label>音量</label>
        <input id="volume" type="range" min="0" max="100" value="60"/>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="start" class="primary">開始</button>
      </div>
      <div style="display:flex;align-items:flex-end;gap:6px;">
        <button id="reset" class="sub">リセット</button>
        <button id="skip" class="warn">スキップ</button>
      </div>
    </div>

    <div class="prompt" id="prompt">（ここにB列の問題が表示されます）</div>
    <div class="hint" id="hint">（ここにC列の答えを入力してください）</div>
    <input id="input" type="text" placeholder="ここに解答（C列の英語）を入力" disabled/>

    <div class="controls-row">
      <label class="small"><input type="checkbox" id="showlog"> ログ表示</label>
      <div class="small" id="feedback"></div>
    </div>
    <div id="log" class="log"></div>
  </div>
</main>

<div id="overlay" class="overlay">
  <div class="result-card">
    <div class="result-badge" id="ovBadge">RESULT</div>
    <div class="result-title" id="ovTitle">Great!</div>
    <div class="result-detail" id="ovDetail"></div>
    <div class="result-small" id="ovSmall"></div>
    <button id="ovClose" class="result-close">閉じる</button>
  </div>
</div>

<script>
const DATA = [{"id": 1, "q": "[f       ] her advice　彼女の助言に従う", "a": "follow"}, {"id": 2, "q": "[c       ] the problem seriously　真剣にその問題を考える", "a": "consider"}, {"id": 3, "q": "[i       ] by 20%　20%増加する", "a": "increase"}, {"id": 4, "q": "[e       ] you to arrive soon　君がすぐ着くことを予期する", "a": "expect"}, {"id": 5, "q": "[d       ] to tell the truth　真実を語る決意をする", "a": "decide"}, {"id": 6, "q": "[d       ] a unique ability　特異な能力を発達させる", "a": "develop"}, {"id": 7, "q": "[p       ] him with information　彼に情報を与える", "a": "provide"}, {"id": 8, "q": "[c       ] to grow fast　急速に成長し続ける", "a": "continue"}, {"id": 9, "q": "The list [i       ] his name.　リストは彼の名前を含んでいる", "a": "includes"}, {"id": 10, "q": "[r       ] silent　黙ったままでいる", "a": "remain"}, {"id": 11, "q": "[r       ] the mountain top　山頂に達する", "a": "reach"}, {"id": 12, "q": "[a       ] him to go out　彼に外出を許可する", "a": "allow"}, {"id": 13, "q": "be [f       ] to work　働くよう強制される", "a": "forced"}, {"id": 14, "q": "[o       ] help to the poor　貧しい人に援助を申し出る", "a": "offer"}, {"id": 15, "q": "[r       ] the error　まちがいを悟る", "a": "realize"}, {"id": 16, "q": "[s       ] a new way　新しいやり方を提案する", "a": "suggest"}, {"id": 17, "q": "[r       ] more attention　もっと注意を必要とする", "a": "require"}, {"id": 18, "q": "[w       ] about money　お金のことを心配する", "a": "worry"}, {"id": 19, "q": "[w       ] where he has gone　彼はどこに行ったのかと思う", "a": "wonder"}, {"id": 20, "q": "The car [c       ] me $50,000.　その車には5万ドルかかった", "a": "cost"}, {"id": 21, "q": "[t       ] to get angry　腹を立てがちである", "a": "tend"}, {"id": 22, "q": "Everything [d       ] on him.　すべては彼しだいだ", "a": "depends"}, {"id": 23, "q": "[s       ] a room with a friend　友人と部屋を共有する", "a": "share"}, {"id": 24, "q": "[d       ] more freedom　もっと自由を要求する", "a": "demand"}, {"id": 25, "q": "[s       ] the president　大統領を支持する", "a": "support"}, {"id": 26, "q": "[h       ] many young people　多くの若者を雇う", "a": "hire"}, {"id": 27, "q": "[r       ] him as a friend　彼を友達とみなす", "a": "regard"}, {"id": 28, "q": "This story is [b       ] on fact.　この話は事実に基づいている", "a": "based"}, {"id": 29, "q": "[i       ] living conditions　生活状態を向上させる", "a": "improve"}, {"id": 30, "q": "[r       ] the importance　重要性を認める", "a": "recognize"}, {"id": 31, "q": "[n       ] the color change　色彩の変化に気づく", "a": "notice"}, {"id": 32, "q": "You are [s       ] to wear a seat belt.　シートベルトを締めることになっている", "a": "supposed"}, {"id": 33, "q": "[r       ] both hands　両手を上げる", "a": "raise"}, {"id": 34, "q": "[p       ] tea to coffee　コーヒーよりお茶を好む", "a": "prefer"}, {"id": 35, "q": "[c       ] up the patients　患者たちを元気づける", "a": "cheer"}, {"id": 36, "q": "[s       ] heavy damage　ひどい損害を受ける", "a": "suffer"}, {"id": 37, "q": "[d       ] the lost bag　なくしたバッグの特徴を言う", "a": "describe"}, {"id": 38, "q": "[p       ] him from sleeping　彼が眠るのをさまたげる", "a": "prevent"}, {"id": 39, "q": "[r       ] energy costs　エネルギー費を減らす", "a": "reduce"}, {"id": 40, "q": "[m       ] salt for sugar　塩を砂糖とまちがえる", "a": "mistake"}, {"id": 41, "q": "[p       ] a room for a guest　客のために部屋を準備する", "a": "prepare"}, {"id": 42, "q": "[e       ] children to read　子供に読書をすすめる", "a": "encourage"}, {"id": 43, "q": "[p       ] to be true　本当だとわかる", "a": "prove"}, {"id": 44, "q": "[t       ] him like a child　子供みたいに彼をあつかう", "a": "treat"}, {"id": 45, "q": "[e       ] a company　会社を設立する", "a": "establish"}, {"id": 46, "q": "stress-[r       ] illness　ストレスと関係のある病気", "a": "related"}, {"id": 47, "q": "[c       ] Japan with China　日本と中国を比較する", "a": "compare"}, {"id": 48, "q": "[s       ] the tablecloth　テーブルクロスを広げる", "a": "spread"}, {"id": 49, "q": "What does this word [r       ] to?　この語は何を指示するか", "a": "refer"}, {"id": 50, "q": "[s       ] the city with water　その都市に水を供給する", "a": "supply"}, {"id": 51, "q": "[g       ] useful knowledge　有益な知識を得る", "a": "gain"}, {"id": 52, "q": "[d       ] forests　森林を破壊する", "a": "destroy"}, {"id": 53, "q": "[a       ] the rule to every case　全ての場合に規則を当てはめる", "a": "apply"}, {"id": 54, "q": "[s       ] help from the police　警察に助けを求める", "a": "seek"}, {"id": 55, "q": "[s       ] for the stolen car　盗難車を捜す", "a": "search"}, {"id": 56, "q": "He [c       ] that he saw a UFO.　彼はUFOを見たと主張する", "a": "claims"}, {"id": 57, "q": "[d       ] a map　地図を描く", "a": "draw"}, {"id": 58, "q": "[r       ] to give up hope　希望を捨てるのを拒む", "a": "refuse"}, {"id": 59, "q": "[r       ] to questions　質問に答える", "a": "respond"}, {"id": 60, "q": "Never [m       ] it again.　二度とそのことを口にするな", "a": "mention"}, {"id": 61, "q": "[j       ] a person by his looks　人を外見で判断する", "a": "judge"}, {"id": 62, "q": "The plane is [a       ] Chicago.　飛行機はシカゴに接近している", "a": "approaching"}, {"id": 63, "q": "I [a       ] that I was wrong.　自分がまちがっていたと認める", "a": "admit"}, {"id": 64, "q": "[r       ] the mood of the times　時代の気分を反映する", "a": "reflect"}, {"id": 65, "q": "[p       ] the job　仕事を遂行する", "a": "perform"}, {"id": 66, "q": "a very [b       ] movie　すごく退屈な映画", "a": "boring"}, {"id": 67, "q": "[s       ] in the jungle　ジャングルで生き残る", "a": "survive"}, {"id": 68, "q": "Words [r       ] ideas.　言葉は考えを表す", "a": "represent"}, {"id": 69, "q": "[a       ] that he is right　彼は正しいと主張する", "a": "argue"}, {"id": 70, "q": "take freedom for [g       ]　自由を当然と考える", "a": "granted"}, {"id": 71, "q": "The data [i       ] that he is right.　データは彼が正しいことを示す", "a": "indicate"}, {"id": 72, "q": "The book [b       ] to Howard.　その本はハワードのものだ", "a": "belongs"}, {"id": 73, "q": "[a       ] a language 　言語を習得する", "a": "acquire"}, {"id": 74, "q": "[r       ] to his letter　彼の手紙に返事をする", "a": "reply"}, {"id": 75, "q": "[f       ] a large family　大勢の家族を養う", "a": "feed"}, {"id": 76, "q": "[e       ] from reality　現実から逃避する", "a": "escape"}, {"id": 77, "q": "[r       ] the old system　古い制度に取って代わる", "a": "replace"}, {"id": 78, "q": "[r       ] a surprising fact　驚くべき事実を明らかにする", "a": "reveal"}, {"id": 79, "q": "Japan is [s       ] by the sea.　日本は海に囲まれている", "a": "surrounded"}, {"id": 80, "q": "The job [s       ] you.　その仕事は君に合っている", "a": "suits"}, {"id": 81, "q": "the [e       ] population of Japan　日本の推定人口", "a": "estimated"}, {"id": 82, "q": "[a       ] at the Asian market　アジア市場をねらう", "a": "aim"}, {"id": 83, "q": "[e       ] money for the family　家族のためにお金をかせぐ", "a": "earn"}, {"id": 84, "q": "My memory began to [d       ].　記憶力が低下し始めた", "a": "decline"}, {"id": 85, "q": "can't [a       ] to buy a Ford　フォードの車を買う余裕がない", "a": "afford"}, {"id": 86, "q": "be [c       ] by her anger　彼女の怒りに当惑する", "a": "confused"}, {"id": 87, "q": "[g       ] from high school　高校を卒業する", "a": "graduate"}, {"id": 88, "q": "[v       ] from country to country　国によって変わる", "a": "vary"}, {"id": 89, "q": "[r       ] the cover　カバーを取り除く", "a": "remove"}, {"id": 90, "q": "[i       ] on going to France　フランスに行くと言い張る", "a": "insist"}, {"id": 91, "q": "[e       ] every record　あらゆる記録を調べる", "a": "examine"}, {"id": 92, "q": "[r       ] him of the promise 　彼に約束を思い出させる", "a": "remind"}, {"id": 93, "q": "[c       ] to world peace　世界平和に貢献する", "a": "contribute"}, {"id": 94, "q": "[w       ] him of the danger　彼に危険を警告する", "a": "warn"}, {"id": 95, "q": "[c       ] the computer to the Internet　コンピュータをインターネットにつなぐ", "a": "connect"}, {"id": 96, "q": "[m       ] him in power　力で彼に匹敵する", "a": "match"}, {"id": 97, "q": "[f       ] on the problem　その問題に焦点を合わせる", "a": "focus"}, {"id": 98, "q": "[r       ] the proposal　提案を拒否する", "a": "reject"}, {"id": 99, "q": "[c       ] him that it is true　それは本当だと彼に確信させる", "a": "convince"}, {"id": 100, "q": "Health is [a       ] with happiness.　健康は幸福と関連している", "a": "associated"}];

const UI = {
  startId: document.getElementById('startId'),
  endId: document.getElementById('endId'),
  order: document.getElementById('order'),
  judge: document.getElementById('judge'),
  limit: document.getElementById('limit'),
  volume: document.getElementById('volume'),
  start: document.getElementById('start'),
  reset: document.getElementById('reset'),
  skip: document.getElementById('skip'),
  input: document.getElementById('input'),
  prompt: document.getElementById('prompt'),
  hint: document.getElementById('hint'),
  progress: document.getElementById('progress'),
  correct: document.getElementById('correct'),
  mist: document.getElementById('mist'),
  wpm: document.getElementById('wpm'),
  remain: document.getElementById('remain'),
  feedback: document.getElementById('feedback'),
  showlog: document.getElementById('showlog'),
  log: document.getElementById('log'),
  overlay: document.getElementById('overlay'),
  ovBadge: document.getElementById('ovBadge'),
  ovTitle: document.getElementById('ovTitle'),
  ovDetail: document.getElementById('ovDetail'),
  ovSmall: document.getElementById('ovSmall'),
  ovClose: document.getElementById('ovClose'),
};

let seq = [], idx = 0, correct = 0, mist = 0, typed = 0;
let startAt = 0, timer = null, endAt = 0;
let perQuestionTimer = null, lastTypeTime = 0, flashedForThis = false;

function log(msg, cls){
  if(!UI.showlog.checked) return;
  const d = document.createElement('div');
  d.textContent = msg;
  d.className = 'log-entry' + (cls ? ' ' + cls : '');
  UI.log.prepend(d);
}
UI.showlog.addEventListener('change', ()=>{UI.log.style.display = UI.showlog.checked ? 'block':'none';});

// --- Audio (Web Audio API) ---
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playTone(type){
  ensureAudio();
  const vol = parseInt(UI.volume.value,10)/100;
  if(vol <= 0) return;
  const ctx = audioCtx;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  let freq = 440;
  if(type === 'ok') freq = 880;
  else if(type === 'ng') freq = 240;
  else if(type === 'time') freq = 440;
  osc.frequency.setValueAtTime(freq, ctx.currentTime);
  gain.gain.value = vol * 0.3;
  osc.connect(gain); gain.connect(ctx.destination);
  if(type === 'time'){
    osc.frequency.linearRampToValueAtTime(220, ctx.currentTime + 0.6);
  }
  osc.start();
  osc.stop(ctx.currentTime + 0.35);
}

// --- helpers ---
function shuffle(a){
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
function norm(s){return s.toLowerCase().replace(/\s+/g,' ').trim();}
function setStats(){
  UI.progress.textContent = idx + ' / ' + seq.length;
  UI.correct.textContent = correct;
  UI.mist.textContent = mist;
}
function wpm(){
  const mins = (Date.now()-startAt)/60000;
  return mins>0 ? Math.round(typed/5/mins) : 0;
}
function fmt(ms){
  const s = Math.max(0, Math.ceil(ms/1000));
  const m = Math.floor(s/60);
  const ss = String(s%60).padStart(2,'0');
  return m+':'+ss;
}

function buildSequence(){
  let s = parseInt(UI.startId.value,10) || 1;
  let e = parseInt(UI.endId.value,10) || DATA.length;
  if(s<1) s=1;
  if(e>DATA.length) e=DATA.length;
  if(s>e) [s,e] = [e,s];
  UI.startId.value = s;
  UI.endId.value = e;
  seq = DATA.filter(item => item.id >= s && item.id <= e);
  if(UI.order.value === 'asc') seq.sort((a,b)=>a.id-b.id);
  else if(UI.order.value === 'desc') seq.sort((a,b)=>b.id-a.id);
  else shuffle(seq);
}

function showQuestion(){
  if(perQuestionTimer){clearInterval(perQuestionTimer); perQuestionTimer=null;}
  if(idx >= seq.length) return finish(false);
  const cur = seq[idx];
  UI.prompt.textContent = cur.q;
  UI.hint.classList.remove('flash-answer');
  UI.hint.textContent = 'ヒント：' + cur.a.replace(/\S/g,'•');
  UI.input.value = '';
  UI.input.focus();
  lastTypeTime = Date.now();
  flashedForThis = false;
  setStats();

  perQuestionTimer = setInterval(()=>{
    const now = Date.now();
    if(!flashedForThis && now - lastTypeTime >= 5000){
      flashedForThis = true;
      const masked = 'ヒント：' + cur.a.replace(/\S/g,'•');
      UI.hint.classList.add('flash-answer');
      UI.hint.textContent = '答え：' + cur.a;
      setTimeout(()=>{
        UI.hint.classList.remove('flash-answer');
        UI.hint.textContent = masked;
      }, 1600);
    }
  }, 500);
}

function start(){
  buildSequence();
  idx = 0; correct = 0; mist = 0; typed = 0;
  startAt = Date.now();
  UI.wpm.textContent = '0';
  UI.input.disabled = false;
  UI.feedback.textContent = '';
  if(timer) clearInterval(timer);
  if(perQuestionTimer){clearInterval(perQuestionTimer); perQuestionTimer=null;}
  const lim = parseInt(UI.limit.value,10);
  endAt = lim ? Date.now() + lim*60000 : 0;
  if(endAt){
    timer = setInterval(()=>{
      const left = endAt - Date.now();
      UI.remain.textContent = fmt(left);
      if(left <= 0) finish(true);
      UI.wpm.textContent = wpm();
    }, 250);
  } else {
    UI.remain.textContent = '--:--';
    timer = setInterval(()=>{UI.wpm.textContent = wpm();}, 500);
  }
  setStats();
  showQuestion();
}

function skipCurrent(){
  if(idx >= seq.length) return;
  log('#'+seq[idx].id+' スキップ ['+seq[idx].q+'] → '+seq[idx].a, 'ng');
  mist++;
  playTone('ng');
  idx++;
  setStats();
  showQuestion();
}

function showResultOverlay(byTime, spentSec){
  const mins = spentSec/60 || 1;
  const perMin = correct/mins;
  let label = 'Good';
  let title = 'Good!';
  let grad = 'linear-gradient(90deg,#4facfe,#00f2fe)';
  if(perMin <= 5){
    label = 'Poor'; title = 'Keep Going!'; grad='linear-gradient(90deg,#555,#888)';
  } else if(perMin <=10){
    label = 'Good'; title = 'Nice!'; grad='linear-gradient(90deg,#4facfe,#00f2fe)';
  } else if(perMin <=15){
    label = 'Great'; title = 'Great!'; grad='linear-gradient(90deg,#67e8f9,#22c55e)';
  } else if(perMin <=20){
    label = 'Excellent'; title = 'Excellent!!'; grad='linear-gradient(90deg,#f97316,#facc15)';
  } else {
    label = 'Perfect'; title = 'Perfect!!!'; grad='linear-gradient(90deg,#a855f7,#ec4899)';
  }
  UI.ovBadge.style.backgroundImage = grad;
  UI.ovBadge.textContent = label;
  UI.ovTitle.textContent = title;
  const perMinStr = perMin.toFixed(1);
  UI.ovDetail.textContent = '正答 '+correct+' / '+seq.length+'・ミス/スキップ '+mist+'・平均 '+perMinStr+' 問/分';
  UI.ovSmall.textContent = byTime ? '時間切れまでよく頑張りました！もう一度挑戦してみましょう。' : 'お疲れさまでした！苦手なところをもう一度復習してみましょう。';
  UI.overlay.classList.add('visible');

  // confetti
  const card = UI.overlay.querySelector('.result-card');
  for(let i=0;i<35;i++){
    const p = document.createElement('div');
    p.className = 'confetti-piece';
    const hue = 20 + Math.random()*320;
    p.style.background = 'hsl('+hue+',90%,60%)';
    p.style.left = (Math.random()*100)+'%';
    p.style.setProperty('--dx', (Math.random()*120-60)+'px');
    p.style.animationDelay = (Math.random()*0.6)+'s';
    card.appendChild(p);
    setTimeout(()=>p.remove(), 2200);
  }
}

function finish(byTime){
  if(timer) {clearInterval(timer); timer=null;}
  if(perQuestionTimer){clearInterval(perQuestionTimer); perQuestionTimer=null;}
  UI.input.disabled = true;
  const spent = (Date.now()-startAt)/1000;
  const perMin = ((correct)/(spent/60||1)).toFixed(1);
  UI.feedback.textContent = (byTime ? '時間切れ' : '終了') + '：正答 '+correct+' / '+seq.length+'，ミス '+mist+'，平均 '+perMin+'問/分';
  if(byTime) playTone('time');
  showResultOverlay(byTime, spent);
}

UI.input.addEventListener('input',(e)=>{
  const v = e.target.value;
  lastTypeTime = Date.now();
  if(e.inputType === 'insertText' && v.length > (e.target._prevLen || 0)) typed++;
  e.target._prevLen = v.length;
  const cur = seq[idx]; if(!cur) return;
  const target = cur.a;
  const mode = UI.judge.value;
  const ok = (mode === 'strict') ? (v === target) : (norm(v) === norm(target));
  if(mode === 'strict' && !target.startsWith(v)) {
    mist++; setStats(); playTone('ng');
    log('#'+cur.id+' ミスタイプ ['+cur.q+'] → '+v+' (正:'+target+')','ng');
  }
  if(ok){
    correct++; setStats(); playTone('ok');
    log('#'+cur.id+' 正解 ['+cur.q+'] → '+target,'ok');
    idx++;
    showQuestion();
  }
});

UI.start.addEventListener('click', start);
UI.reset.addEventListener('click', ()=>{
  if(timer) {clearInterval(timer); timer=null;}
  if(perQuestionTimer){clearInterval(perQuestionTimer); perQuestionTimer=null;}
  seq = []; idx = 0; correct = 0; mist = 0; typed = 0;
  UI.input.value=''; UI.input.disabled = true;
  UI.progress.textContent='0 / 0';
  UI.correct.textContent='0';
  UI.mist.textContent='0';
  UI.wpm.textContent='0';
  UI.remain.textContent='--:--';
  UI.prompt.textContent='（ここにB列の問題が表示されます）';
  UI.hint.textContent='（ここにC列の答えを入力してください）';
  UI.feedback.textContent='';
  UI.log.innerHTML='';
});
UI.skip.addEventListener('click', skipCurrent);

UI.ovClose.addEventListener('click', ()=>{UI.overlay.classList.remove('visible');});
UI.overlay.addEventListener('click',(e)=>{if(e.target === UI.overlay) UI.overlay.classList.remove('visible');});
</script>
</body>
</html>
